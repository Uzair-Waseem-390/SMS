{% extends 'base.html' %}
{% load school_urls %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-6"><h2><i class="bi bi-award"></i> Generate Certificate - Step 1</h2></div>
        <div class="col-md-6 text-end">
            <a href="{% sb_url 'certificate:template_list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">Select Template and Recipient</div>
        <div class="card-body">
            <p class="text-muted">Choose a certificate template, then select Class and Section to narrow down students, or pick an employee for experience certificates.</p>
            <form method="post" id="cert-gen-form">
                {% csrf_token %}
                {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
                <div class="mb-3">
                    <label for="id_template" class="form-label">{{ form.template.label }}</label>
                    {{ form.template }}
                    {% if form.template.errors %}<div class="text-danger small">{{ form.template.errors.0 }}</div>{% endif %}
                </div>

                <div id="cert-student-block">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="id_class_filter" class="form-label">Class</label>
                            <select id="id_class_filter" class="form-select">
                                <option value="">All Classes</option>
                                {% for c in classes %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="id_section_filter" class="form-label">Section</label>
                            <select id="id_section_filter" class="form-select">
                                <option value="">All Sections</option>
                                {% for s in sections %}
                                <option value="{{ s.id }}" data-class-id="{{ s.class_obj_id }}">{{ s.class_obj.name }} - {{ s.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="id_student" class="form-label">{{ form.student.label }}</label>
                            <select name="student" id="id_student" class="form-select">
                                <option value="">---------</option>
                                {% for value, label in form.fields.student.widget.choices %}
                                {% if value %}<option value="{{ value }}">{{ label }}</option>{% endif %}
                                {% endfor %}
                            </select>
                            {% if form.student.errors %}<div class="text-danger small">{{ form.student.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <div id="cert-employee-block" style="display:none;">
                    <div class="mb-3">
                        <label for="id_employee_id" class="form-label">{{ form.employee_id.label }}</label>
                        {{ form.employee_id }}
                        {% if form.employee_id.errors %}<div class="text-danger small">{{ form.employee_id.errors.0 }}</div>{% endif %}
                    </div>
                </div>

                <button type="submit" name="submit" class="btn btn-primary">Continue</button>
            </form>
        </div>
    </div>

    <div class="mt-3">
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> Filter by Class then Section to find students easily. Employee certificates: Experience (Managers can only be certified by Principal).
        </small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var studentsMeta = {{ students_meta_json|safe }};
    var templateSelect = document.getElementById('id_template');
    var classFilter = document.getElementById('id_class_filter');
    var sectionFilter = document.getElementById('id_section_filter');
    var studentSelect = document.getElementById('id_student');
    var studentBlock = document.getElementById('cert-student-block');
    var employeeBlock = document.getElementById('cert-employee-block');

    function isExperienceTemplate() {
        var sel = templateSelect && templateSelect.options[templateSelect.selectedIndex];
        if (!sel || !sel.value) return false;
        return (sel.text || '').toLowerCase().indexOf('experience') >= 0;
    }

    function toggleRecipient() {
        var showStudent = !isExperienceTemplate();
        if (studentBlock) studentBlock.style.display = showStudent ? '' : 'none';
        if (employeeBlock) employeeBlock.style.display = showStudent ? 'none' : '';
    }

    // Attach data-section-id and data-class-id to student options (same order as students_meta_json)
    if (studentSelect && studentsMeta && studentsMeta.length) {
        var opts = studentSelect.querySelectorAll('option');
        var idx = 0;
        for (var i = 0; i < opts.length; i++) {
            if (opts[i].value === '') continue;
            if (idx < studentsMeta.length) {
                opts[i].setAttribute('data-section-id', studentsMeta[idx].section_id);
                opts[i].setAttribute('data-class-id', studentsMeta[idx].class_id);
                idx++;
            }
        }
    }

    function filterSections() {
        var classId = classFilter ? classFilter.value : '';
        var sectionOpts = sectionFilter ? sectionFilter.querySelectorAll('option') : [];
        for (var i = 0; i < sectionOpts.length; i++) {
            var opt = sectionOpts[i];
            if (opt.value === '') {
                opt.style.display = '';
                continue;
            }
            var cid = opt.getAttribute('data-class-id');
            opt.style.display = (!classId || cid === classId) ? '' : 'none';
        }
        if (sectionFilter) sectionFilter.value = '';
        filterStudents();
    }

    function filterStudents() {
        var sectionId = sectionFilter ? sectionFilter.value : '';
        var classId = classFilter ? classFilter.value : '';
        var opts = studentSelect ? studentSelect.querySelectorAll('option') : [];
        for (var i = 0; i < opts.length; i++) {
            var opt = opts[i];
            if (opt.value === '') {
                opt.style.display = '';
                continue;
            }
            var sid = opt.getAttribute('data-section-id');
            var cid = opt.getAttribute('data-class-id');
            var show = true;
            if (sectionId) show = sid === sectionId;
            else if (classId) show = cid === classId;
            opt.style.display = show ? '' : 'none';
        }
        if (studentSelect) studentSelect.value = '';
    }

    if (templateSelect) templateSelect.addEventListener('change', toggleRecipient);
    if (classFilter) classFilter.addEventListener('change', filterSections);
    if (sectionFilter) sectionFilter.addEventListener('change', filterStudents);
    toggleRecipient();
    filterSections();
})();
</script>
{% endblock %}
