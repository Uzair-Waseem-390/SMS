{% extends 'base.html' %}
{% load school_urls %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0"><i class="bi bi-graph-up"></i> Financial Report</h4>
            <small class="text-muted">{{ branch.name }}{% if date_from or date_to %} &middot; {% if date_from %}{{ date_from }}{% endif %} - {% if date_to %}{{ date_to }}{% endif %}{% endif %}</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="window.print()"><i class="bi bi-printer"></i> Print</button>
            <a href="{% sb_url 'finance:dashboard' %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-left"></i> Dashboard</a>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="card mb-3 shadow-sm">
        <div class="card-body py-2">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-auto">
                    <label class="form-label mb-0 small">From</label>
                    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}">
                </div>
                <div class="col-auto">
                    <label class="form-label mb-0 small">To</label>
                    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                    <a href="{% sb_url 'finance:financial_report' %}" class="btn btn-sm btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Row 1: Key Summary (6 cards) -->
    <div class="row g-2 mb-3">
        <div class="col-6 col-md-2">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Fee Collected</small>
                    <h5 class="mb-0">{{ total_collected|floatformat:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-warning text-dark shadow-sm h-100">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Pending Fees</small>
                    <h5 class="mb-0">{{ total_pending|floatformat:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-danger text-white shadow-sm h-100">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Expenses</small>
                    <h5 class="mb-0">{{ total_expenses|floatformat:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-info text-white shadow-sm h-100">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Salaries Paid</small>
                    <h5 class="mb-0">{{ total_salaries|floatformat:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card shadow-sm h-100 {% if net_profit >= 0 %}bg-primary text-white{% else %}bg-dark text-white{% endif %}">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Net Profit</small>
                    <h5 class="mb-0">{{ net_profit|floatformat:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card bg-secondary text-white shadow-sm h-100">
                <div class="card-body py-2 text-center">
                    <small class="opacity-75">Collection Rate</small>
                    <h5 class="mb-0">{{ collection_rate|floatformat:1 }}%</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Profit Breakdown + Fee Status + Fee Type Analysis -->
    <div class="row g-2 mb-3">
        <!-- Profit Breakdown -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-calculator"></i> Profit / Loss Statement</strong></div>
                <div class="card-body py-2">
                    <table class="table table-sm mb-0">
                        <tbody>
                            <tr class="table-success">
                                <td><i class="bi bi-arrow-down-circle"></i> Fee Collected (Income)</td>
                                <td class="text-end fw-bold">PKR {{ total_collected|floatformat:0 }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td><i class="bi bi-dash-circle"></i> Expenses</td>
                                <td class="text-end">-PKR {{ total_expenses|floatformat:0 }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td><i class="bi bi-dash-circle"></i> Salaries Paid</td>
                                <td class="text-end">-PKR {{ total_salaries|floatformat:0 }}</td>
                            </tr>
                            <tr class="table-secondary">
                                <td>Total Outflow</td>
                                <td class="text-end fw-bold">-PKR {{ total_outflow|floatformat:0 }}</td>
                            </tr>
                            <tr class="{% if net_profit >= 0 %}table-primary{% else %}table-dark{% endif %} fw-bold">
                                <td><i class="bi bi-trophy"></i> Net Profit</td>
                                <td class="text-end">PKR {{ net_profit|floatformat:0 }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr class="my-2">
                    <table class="table table-sm table-borderless mb-0 small text-muted">
                        <tr><td>Total Receivable</td><td class="text-end">PKR {{ total_receivable|floatformat:0 }}</td></tr>
                        <tr><td>Scholarship Given</td><td class="text-end">-PKR {{ total_scholarship_given|floatformat:0 }}</td></tr>
                        <tr><td>Salaries Pending</td><td class="text-end">PKR {{ total_salaries_pending|floatformat:0 }}</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fee Status -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-pie-chart"></i> Fee Status Breakdown</strong></div>
                <div class="card-body py-2">
                    <table class="table table-sm mb-3">
                        <thead class="table-light"><tr><th>Status</th><th class="text-center">Count</th><th class="text-end">%</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><span class="badge bg-success">Paid</span></td>
                                <td class="text-center fw-bold">{{ paid_count }}</td>
                                <td class="text-end">{% if total_fees_count %}{% widthratio paid_count total_fees_count 100 %}{% else %}0{% endif %}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning text-dark">Partial</span></td>
                                <td class="text-center fw-bold">{{ partial_count }}</td>
                                <td class="text-end">{% if total_fees_count %}{% widthratio partial_count total_fees_count 100 %}{% else %}0{% endif %}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-danger">Unpaid</span></td>
                                <td class="text-center fw-bold">{{ unpaid_count }}</td>
                                <td class="text-end">{% if total_fees_count %}{% widthratio unpaid_count total_fees_count 100 %}{% else %}0{% endif %}%</td>
                            </tr>
                            <tr class="table-light fw-bold">
                                <td>Total</td>
                                <td class="text-center">{{ total_fees_count }}</td>
                                <td class="text-end">100%</td>
                            </tr>
                        </tbody>
                    </table>
                    {% if total_fees_count %}
                    <div class="progress" style="height:20px">
                        <div class="progress-bar bg-success" style="width:{% widthratio paid_count total_fees_count 100 %}%">Paid</div>
                        <div class="progress-bar bg-warning" style="width:{% widthratio partial_count total_fees_count 100 %}%">Partial</div>
                        <div class="progress-bar bg-danger" style="width:{% widthratio unpaid_count total_fees_count 100 %}%">Unpaid</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Fee Type Analysis -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-tags"></i> Fee Type Analysis</strong></div>
                <div class="card-body py-2">
                    <table class="table table-sm mb-0">
                        <thead class="table-light"><tr><th>Type</th><th class="text-center">Count</th><th class="text-end">Collected</th><th class="text-end">Pending</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><span class="badge bg-primary">Academic</span></td>
                                <td class="text-center">{{ academic_count }}</td>
                                <td class="text-end text-success">{{ academic_collected|floatformat:0 }}</td>
                                <td class="text-end text-danger">{{ academic_pending|floatformat:0 }}</td>
                            </tr>
                            <tr>
                                <td><span class="badge" style="background:#6f42c1">Special</span></td>
                                <td class="text-center">{{ special_count }}</td>
                                <td class="text-end text-success">{{ special_collected|floatformat:0 }}</td>
                                <td class="text-end text-danger">{{ special_pending|floatformat:0 }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr class="my-2">
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between"><span>Scholarship Discounts Given</span><span class="fw-bold">PKR {{ total_scholarship_given|floatformat:0 }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Monthly Trends Table -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-bar-chart-line"></i> Monthly Trends (Last 6 Months)</strong></div>
                <div class="card-body py-2">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered text-center mb-2">
                            <thead class="table-light">
                                <tr>
                                    <th>Month</th>
                                    {% for m in monthly_data %}<th>{{ m.label }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-bold text-start"><i class="bi bi-arrow-down-circle text-success"></i> Income</td>
                                    {% for m in monthly_data %}<td class="text-success">{{ m.income|floatformat:0 }}</td>{% endfor %}
                                </tr>
                                <tr>
                                    <td class="fw-bold text-start"><i class="bi bi-receipt-cutoff text-danger"></i> Expenses</td>
                                    {% for m in monthly_data %}<td class="text-danger">{{ m.expense|floatformat:0 }}</td>{% endfor %}
                                </tr>
                                <tr>
                                    <td class="fw-bold text-start"><i class="bi bi-wallet2 text-info"></i> Salaries</td>
                                    {% for m in monthly_data %}<td class="text-info">{{ m.salary|floatformat:0 }}</td>{% endfor %}
                                </tr>
                                <tr class="table-light fw-bold">
                                    <td class="text-start"><i class="bi bi-trophy"></i> Profit</td>
                                    {% for m in monthly_data %}<td class="{% if m.profit >= 0 %}text-primary{% else %}text-danger{% endif %}">{{ m.profit|floatformat:0 }}</td>{% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Visual bar representation -->
                    {% if monthly_data %}
                    <div class="row g-1 mt-2">
                        {% for m in monthly_data %}
                        <div class="col text-center">
                            <div class="d-flex flex-column align-items-center" style="height:100px;justify-content:flex-end">
                                {% if m.income %}
                                <div class="bg-success rounded-top" style="width:70%;min-height:4px;height:{% widthratio m.income monthly_data.0.income 80 %}px" title="Income: PKR {{ m.income|floatformat:0 }}"></div>
                                {% endif %}
                                {% if m.expense %}
                                <div class="bg-danger" style="width:70%;min-height:4px;height:{% widthratio m.expense monthly_data.0.income 80 %}px" title="Expense: PKR {{ m.expense|floatformat:0 }}"></div>
                                {% endif %}
                                {% if m.salary %}
                                <div class="bg-info rounded-bottom" style="width:70%;min-height:4px;height:{% widthratio m.salary monthly_data.0.income 80 %}px" title="Salary: PKR {{ m.salary|floatformat:0 }}"></div>
                                {% endif %}
                            </div>
                            <small class="text-muted d-block" style="font-size:.7rem">{{ m.label }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="d-flex gap-3 justify-content-center mt-2 small">
                        <span><span class="badge bg-success">&nbsp;</span> Income</span>
                        <span><span class="badge bg-danger">&nbsp;</span> Expenses</span>
                        <span><span class="badge bg-info">&nbsp;</span> Salaries</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Row 4: Expense Categories + Salary by Employee Type -->
    <div class="row g-2 mb-3">
        <!-- Expense Categories -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-receipt-cutoff"></i> Expenses by Category</strong></div>
                <div class="card-body py-2">
                    {% if expense_by_cat %}
                    <table class="table table-sm mb-0">
                        <thead class="table-light"><tr><th>Category</th><th class="text-end">Amount (PKR)</th><th class="text-end">Share</th><th style="width:30%"></th></tr></thead>
                        <tbody>
                            {% for item in expense_by_cat %}
                            <tr>
                                <td>{{ item.category }}</td>
                                <td class="text-end fw-bold">{{ item.amount|floatformat:0 }}</td>
                                <td class="text-end small text-muted">{{ item.pct|floatformat:1 }}%</td>
                                <td>
                                    <div class="progress" style="height:14px">
                                        <div class="progress-bar bg-danger" style="width:{{ item.pct|floatformat:0 }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-light fw-bold">
                                <td>Total</td>
                                <td class="text-end text-danger">{{ total_expenses|floatformat:0 }}</td>
                                <td class="text-end">100%</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted text-center mb-0 py-4">No expenses recorded in this period.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Salary by Employee Type -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-people"></i> Salary by Employee Type</strong></div>
                <div class="card-body py-2">
                    {% if salary_by_type %}
                    <table class="table table-sm mb-0">
                        <thead class="table-light"><tr><th>Role</th><th class="text-center">Records</th><th class="text-end">Total</th><th class="text-end text-success">Paid</th><th class="text-end text-danger">Pending</th></tr></thead>
                        <tbody>
                            {% for item in salary_by_type %}
                            <tr>
                                <td>{{ item.employee_type|title }}</td>
                                <td class="text-center">{{ item.count }}</td>
                                <td class="text-end fw-bold">{{ item.total|floatformat:0 }}</td>
                                <td class="text-end text-success">{{ item.paid|floatformat:0 }}</td>
                                <td class="text-end text-danger">{{ item.unpaid|floatformat:0 }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-light fw-bold">
                                <td>Total</td>
                                <td></td>
                                <td class="text-end">PKR {{ total_salaries|floatformat:0 }}</td>
                                <td class="text-end text-success">{{ total_salaries|floatformat:0 }}</td>
                                <td class="text-end text-danger">{{ total_salaries_pending|floatformat:0 }}</td>
                            </tr>
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted text-center mb-0 py-4">No salary records in this period.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Row 5: Top Defaulters -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2"><strong><i class="bi bi-exclamation-triangle text-danger"></i> Top Fee Defaulters</strong></div>
                <div class="card-body py-2">
                    {% if top_defaulters %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th class="text-center">Unpaid Fees</th>
                                    <th class="text-end">Outstanding Balance (PKR)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in top_defaulters %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td><i class="bi bi-person"></i> {{ d.student__first_name }} {{ d.student__last_name }}</td>
                                    <td class="text-center"><span class="badge bg-danger">{{ d.fee_count }}</span></td>
                                    <td class="text-end fw-bold text-danger">{{ d.balance|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0 py-3">No outstanding defaulters found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-2">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-2 d-flex gap-2 flex-wrap justify-content-center">
                    <a href="{% sb_url 'finance:fee_list' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-cash-stack"></i> All Fees</a>
                    <a href="{% sb_url 'finance:expense_list' %}" class="btn btn-outline-danger btn-sm"><i class="bi bi-receipt-cutoff"></i> Expenses</a>
                    <a href="{% sb_url 'finance:salary_list' %}" class="btn btn-outline-info btn-sm"><i class="bi bi-wallet2"></i> Salary Records</a>
                    <a href="{% sb_url 'finance:scholarship_list' %}" class="btn btn-outline-success btn-sm"><i class="bi bi-award"></i> Scholarships</a>
                    <a href="{% sb_url 'finance:dashboard' %}" class="btn btn-primary btn-sm"><i class="bi bi-speedometer2"></i> Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .btn, nav, .sidebar, form, .card-header a { display: none !important; }
    .card { border: 1px solid #ddd !important; box-shadow: none !important; }
    .container-fluid { padding: 0 !important; }
}
</style>
{% endblock %}
