{% load school_urls %}
<aside class="sidebar" id="appSidebar">
    <div class="school-brand">
        <i class="bi bi-mortarboard-fill"></i>
        <span>EduSaaS</span>
    </div>

    <nav class="nav flex-column">
        <a class="nav-link" href="{% sb_url 'dashboard:index' %}">
            <i class="bi bi-speedometer2"></i>
            Dashboard
        </a>

        <div class="sidebar-divider"></div>

        {# Academics toggle — active class ONLY when on an academics page #}
        <a class="nav-link {% if request.resolver_match and 'academics' in request.resolver_match.app_name %}active{% endif %} d-flex"
            data-bs-toggle="collapse" href="#academicsSubmenu" role="button"
            aria-expanded="{% if request.resolver_match and 'academics' in request.resolver_match.app_name %}true{% else %}false{% endif %}"
            aria-controls="academicsSubmenu">
            <span class="link-left">
                <i class="bi bi-journal-bookmark-fill"></i>
                Academics
            </span>
            <i class="bi bi-chevron-down chevron"></i>
        </a>

        <div class="collapse {% if request.resolver_match and 'academics' in request.resolver_match.app_name %}show{% endif %}"
            id="academicsSubmenu">
            <div class="sub-nav d-flex flex-column">
                <a class="nav-link {% if request.resolver_match and 'class' in request.resolver_match.url_name %}active{% endif %}"
                    href="{% sb_url 'academics:class_list' %}">
                    <i class="bi bi-grid-3x2-gap"></i>
                    <small>Classes &amp; Sections</small>
                </a>
                <a class="nav-link {% if request.resolver_match and 'subject' in request.resolver_match.url_name %}active{% endif %}"
                    href="{% sb_url 'academics:subject_list' %}">
                    <i class="bi bi-book-half"></i>
                    <small>Subjects</small>
                </a>
            </div>
        </div>

        <a class="nav-link" href="{% sb_url 'students:student_list' %}">
            <i class="bi bi-people-fill"></i>
            Students
        </a>
        <a class="nav-link" href="{% sb_url 'staff:staff_list' %}">
            <i class="bi bi-person-badge-fill"></i>
            Staff
        </a>
        <a class="nav-link" href="{% sb_url 'attendance:bulk_staff_attendance' %}">
            <i class="bi bi-calendar-check-fill"></i>
            Attendance
        </a>
        <a class="nav-link" href="{% sb_url 'exams:exam_list' %}">
            <i class="bi bi-bar-chart-fill"></i>
            Exams &amp; Results
        </a>

        <div class="sidebar-divider"></div>

        <a class="nav-link" href="{% sb_url 'finance:dashboard' %}">
            <i class="bi bi-cash-stack"></i>
            Finance
        </a>
        <a class="nav-link" href="{% sb_url 'notification:notification_list' %}">
            <i class="bi bi-bell-fill"></i>
            Notifications
        </a>
        <a class="nav-link" href="{% sb_url 'certificate:template_list' %}">
            <i class="bi bi-award-fill"></i>
            Certificates
        </a>

        <div class="sidebar-divider"></div>

        {% if request.user.user_type == 'principal' %}
        <a class="nav-link" href="{% url 'tenants:school_detail' %}">
            <i class="bi bi-building-gear"></i>
            School Settings
        </a>
        <a class="nav-link" href="{% url 'tenants:branch_list' %}">
            <i class="bi bi-diagram-3-fill"></i>
            Manage Branches
        </a>
        <div class="sidebar-divider"></div>
        {% endif %}

        <a class="nav-link" href="{% url 'accounts:profile' %}">
            <i class="bi bi-person-circle"></i>
            My Profile
        </a>
        <a class="nav-link" href="{% url 'accounts:logout' %}">
            <i class="bi bi-box-arrow-right"></i>
            Logout
        </a>
    </nav>

    {% if current_school %}
    <div class="sidebar-info-card">
        <small>
            <i class="bi bi-buildings-fill me-1" style="color:#5eead4;"></i>
            <strong>{{ current_school.name }}</strong>
        </small>
        <small style="color:rgba(255,255,255,0.45); margin-top:2px;">
            <i class="bi bi-geo-alt-fill me-1" style="color:rgba(255,255,255,0.3);"></i>{{ current_branch.name }}
        </small>
    </div>
    {% endif %}
</aside>

<script>
    (function () {
        /* ── Chevron state on page load ── */
        var toggles = document.querySelectorAll('.sidebar .nav-link[data-bs-toggle="collapse"]');
        toggles.forEach(function (el) {
            var chevron = el.querySelector('.chevron');
            if (!chevron) return;
            /* Sync chevron with aria-expanded set by Django */
            if (el.getAttribute('aria-expanded') === 'true') {
                chevron.style.transform = 'rotate(180deg)';
                chevron.style.opacity = '0.8';
            }
            /* On click toggle */
            el.addEventListener('click', function () {
                var isExpanded = el.getAttribute('aria-expanded') === 'true';
                /* aria-expanded flips AFTER the click so we check current */
                setTimeout(function () {
                    var nowExpanded = el.getAttribute('aria-expanded') === 'true';
                    chevron.style.transform = nowExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                    chevron.style.opacity = nowExpanded ? '0.8' : '0.5';
                }, 10);
            });
        });
    })();
</script>